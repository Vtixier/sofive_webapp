<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">

    <title>Sofive Soccer Center</title>

    <meta name="viewport" content="width=device-width, initial-scale = 1, minimum-scale = 1, maximum-scale = 1, user-scalable = no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="apple-touch-icon" href="https://sofive.com/wp-content/uploads/2018/04/cropped-sigle-192x192.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="https://sofive.com/wp-content/uploads/2018/04/cropped-sigle-192x192.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="https://sofive.com/wp-content/uploads/2018/04/cropped-sigle-192x192.png" />
    <meta name="apple-mobile-web-app-title" content="Sofive">
    <style type="text/css">
        body {
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
    </style>

    <link href="/css/plugins/select2/select2.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/switchery/0.8.2/switchery.min.css" rel="stylesheet">

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="/css/animate.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link rel="icon" href="https://sofive.com/wp-content/uploads/2018/04/cropped-sigle-32x32.png" sizes="32x32" />
    <link rel="icon" href="https://sofive.com/wp-content/uploads/2018/04/cropped-sigle-192x192.png" sizes="192x192" />
    <link href="/css/plugins/footable/footable.core.css" rel="stylesheet">

    <link href="/css/plugins/dataTables/datatables.min.css" rel="stylesheet">

</head>

<body class="fixed-sidebar">

    <div id="wrapper">

        <div>
            <sofive-left-menu />
        </div>

        <div id="page-wrapper" class="gray-bg">

            <div>
                <sofive-header />
            </div>

            <div class="wrapper wrapper-content animated fadeInRight" style="padding-bottom: 15px">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox ">
                            <div class="ibox-content text-center p-md">

                                <h2><span class="text-navy">Clubhouse TVs</span> settings.</h2>
                                <p>
                                    Select a template on the left, then send it to your lobby TVs on the right.
                                </p>


                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="ibox ">
                            <div class="ibox-content text-center p-md">
                                <h4 class="m-b-xxs">Templates</h4>
                                <br/>
                                <select class="select_league form-control" v-model="selected_url">
                                    <option value="0">Select a template</option>
                                    <option v-for="url in available_urls" :value="url.path">{{url.name}}</option>
                                </select>
                                <div v-if="selected_url === 'custom_game'">
                                    <br/>
                                    <select class="select_league form-control" v-model="second_selected_url">
                                        <option value="0">Select a match</option>
                                        <option v-for="match in matches" :value="'/screen/video.html?video_id='+match.video_id+'&match_id='+match.id">{{match.match.home}} - {{match.match.away}}</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="col-lg-6">
                        <div class="ibox ">
                            <div class="ibox-content text-center p-md">
                                <h4 class="m-b-xxs">Screens</h4>
                                <br/>
                                <div class="input-group"><input type="text" placeholder="Search" class="form-control-sm form-control" v-model="search_string"></div>
                                <br/>
                                <div class="project-list">
                                    <table class="table table-hover">
                                        <tbody>
                                            <tr v-for="screen in filtered_screens">
                                                <td class="project-status" style="padding: 10">
                                                    <span class="label label-primary" v-if="screen.connected">Online</span>
                                                    <span class="label label-default" v-else>Offline</span>
                                                </td>
                                                <td class="project-title" style="padding: 0">
                                                    <a href="project_detail.html">{{screen.name}}</a>
                                                    <br/>
                                                    <small>{{screen.center}}</small>
                                                </td>
                                                <td class="project-completion" style="padding: 0">
                                                        <a><b>{{getTemplateName(screen.url)}}</b></a>
                                                </td>
                                                <td class="project-actions" style="padding: 10">
                                                    <a href="#" class="btn btn-white btn-sm" v-on:click="save(screen.id)">Send</a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div>
                <sofive-footer />
            </div>
        </div>
    </div>

    <!-- Mainly scripts -->
    <script src="/js/jquery-3.1.1.min.js"></script>
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.js"></script>
    <script src="/js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/switchery/0.8.2/switchery.min.js"></script>

    <!-- Custom and plugin javascript -->
    <script src="/js/inspinia.js"></script>

    <script src="/js/plugins/select2/select2.full.min.js"></script>

    <script src="/js/vue.js"></script>

    <script type="text/javascript" src="/js/vue-resource.js"></script>
    <script type="text/javascript" src="/js/moment.js"></script>

    <script type="text/javascript" src="/js/navigation.js"></script>
    <script type="text/javascript" src="/js/header.js"></script>
    <script type="text/javascript" src="/js/footer.js"></script>

    <script src="/js/plugins/footable/footable.all.min.js"></script>

    <script src="/js/plugins/dataTables/datatables.min.js"></script>
    <script src="/js/plugins/dataTables/dataTables.bootstrap4.min.js"></script>

    <script type="text/javascript">

        var facilityMap = {
            "1": "Sofive Meadowlands",
            "2": "Sofive Elkins Park",
            "3": "Sofive Brooklyn",
            "4": "Sofive Rockville",
            "5": "Sofive Columbia"
        }

        const available_urls = [{
            name: "Intro",
            path: "/screen/intro.html?",
        }, {
            name: "Highlights",
            path: "/screen/video.html?",
        }, {
            name: "Dash fixtures",
            path: "/screen/dash.html?",
        }, {
            name: "Custom Game",
            path: "custom_game",
        }]

        var app = new Vue({
            el: '#wrapper',
            data: {
                loading: true,
                screens: [],
                ws: null,
                new_url: "",
                selected_screen_id: 0,
                selected_url: "0",
                second_selected_url: "0",
                search_string: "",
                matches: []
            },
            mounted: function mounted() {
                this.getScreens()
                this.setupWebsocket()
                this.getDailyHighlights("Brooklyn")
            },
            computed: {
                filtered_screens: function() {
                    if (this.search_string === "") {
                        return this.screens
                    }
                    return this.screens.filter(s => (JSON.stringify(s).toLowerCase().indexOf(this.search_string.toLowerCase()) !== (-1)))
                }
            },
            methods: {
                getScreens: function() {
                    const self = this;
                    this.$http.get(this.backend+"/screen/")
                    .then((resp) => {
                        self.screens = resp.body.map(m => {
                            return {
                                ...m,
                                center: facilityMap[m.facility_id.toString()],
                                connected: false
                            }
                        }).sort((a,b) => {
                            if (b.name<a.name) {
                                return 1
                            }
                            return -1
                        })
                        self.loading = false
                    })
                },
                setupWebsocket: function() {
                    const self = this;
                    self.ws = new WebSocket("wss://socket.sofive.com/ws")
                    self.ws.onopen = function(evt) {
                      console.log("[SOCKET] Connection successfull");
                      self.ws.send(JSON.stringify({admin: true}))
                    }
                    self.ws.onclose = function(evt) {
                      console.log("[SOCKET] Closed");
                      self.ws = null;
                      setTimeout(self.setupWebsocket, 1000)
                    }
                    self.ws.onmessage = function(evt) {
                      console.log("[SOCKET] Got screen data", evt.data);
                      const screen_data = JSON.parse(evt.data)
                      self.screens = self.screens.map(s => ({...s, connected: false}))
                      self.screens = self.screens.map(s => {
                        if (screen_data.screen_id === s.id.toString()) {
                            return {
                                ...s,
                                connected: screen_data.connected
                            }
                        }
                        return s
                      })
                    }
                    self.ws.onerror = function(evt) {
                      console.log("[SOCKET] Error " + evt.data);
                      self.ws.close()
                    }
                },
                editURL: function(screen_id) {
                    this.selected_screen_id = parseInt(screen_id)
                    $('#more_info_modal').modal({
                        keyboard: false
                    });
                },
                save: function(screen_id) {
                    if (this.selected_url === "0") {
                        return
                    }
                    let url = this.selected_url, second = false
                    if (this.selected_url === "custom_game") {
                        if (this.second_selected_url === "0") {
                            return
                        }
                        url = this.second_selected_url
                        second = true
                    }
                    const d = {
                        screen_id,
                        url: second ? "/screen/video.html?" : url
                    }, self = this;
                    console.log(d)
                    self.ws.send(JSON.stringify({
                        screen_id: screen_id.toString(),
                        url
                    }))
                    self.$http.post(this.backend+"/screen/url", d)
                    self.screens = self.screens.map(s => {
                        if (s.id === screen_id) {
                            return {
                                ...s,
                                url: d.url
                            }
                        }
                        return s
                    })
                },
                getDailyHighlights: function(center) {
                    const self = this,
                    // day = moment().format("YYYY-MM-DD")
                    day = "2019-12-07"
                    return this.$http.get("https://video.scoreplay.io/recording/day/"+center+"?day="+day)
                    .then(resp => {
                        const videos = resp.body
                        return Promise.all(videos.map(self.getMatchDetails))
                        .then(vids => {
                            console.log("Videos", vids)
                            let matchMap = {}
                            vids.map(v => {
                                if (!(v.match.home in matchMap)) {
                                    matchMap[v.match.home] = []
                                }
                                matchMap[v.match.home].push(v)
                                if (!(v.match.away in matchMap)) {
                                    matchMap[v.match.away] = []
                                }
                                matchMap[v.match.away].push({
                                    ...v,
                                    match: {
                                        ...v.match,
                                        home: v.match.away, // invers for dropdown
                                        away: v.match.home
                                    }
                                })
                            })
                            let matches = []
                            Object.keys(matchMap).sort().map(team => {
                                matchMap[team].forEach(m => {
                                    matches.push(m)
                                })
                            })
                            self.matches = matches
                        })
                    })
                },
                getMatchDetails: function(v) {
                    const self = this
                    return this.$http.post("https://app.scoreplay.io/match/details", {match_id: v.id})
                    .then(resp => {
                        const vid_url = v.url,
                            video_id = vid_url.slice(vid_url.indexOf("/video") + 7, vid_url.length)
                        return {
                            ...v,
                            video_id,
                            match: {
                                home: resp.body.details.home.teamName,
                                away: resp.body.details.away.teamName,
                                date: resp.body.details.date,
                                league: resp.body.details.event,
                            }
                        }
                    })
                },
                getTemplateName: function(url) {
                    const sel_url = available_urls.find(u => (u.path === url))
                    if (sel_url) {
                        return sel_url.name
                    }
                    return "Auto highlights"
                }
            }
        });
    </script>

</body>

</html>